
.. _nodejs_api:

EJDB Nodejs API
===============

.. js:function:: EJDB.open(dbFile, [openMode], [cb])

    Open a database specified by `dbFile` using the `openMode`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will executed in `synchronous` mode.

    The `openMode` argument is a bitmask of the following flags:

    * `JBOREADER` Open database as a reader.
    * `JBOWRITER` Open database as a writer.
    * `JBOCREAT` Create new database if it not exists.
    * `JBOTRUNC` Trancated database on opening.

    :param string dbFile: The database file path.
    :param number [openMode]: Open mode. Default to: `JBOWRITER | JBOCREAT`
    :param function [cb]: Callback called with an error and EJDB object arguments
    :return: EJDB database instance object `db`.

.. js:function:: EJDB.isValidOID(oid)

    Return `true` if argument is a valid :term:`ObjectId` string.

    :param string oid: Object id
    :return: Boolean value

.. js:function:: db.close([cb])

   Close a database. If database is closed this function does nothing.

   :param function cb: Callback called with an error.

.. js:function:: db.isOpen()

    Check if database is in opened state.

.. js:function:: db.ensureCollection(cname, [copts], [cb])

    Return existing collection or create new collection if it was not created before.
    Collection options `copts` are applied only for newly created collection.
    For existing collections `copts` takes no effect.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will executed in `synchronous` mode.

    `copts`:

    .. code-block:: javascript

        {
          //Max number of cached records in shared memory segment. Default: 0
          'cachedrecords': number,

          //Estimated number of records in this collection. Default: 65535.
          'records': number,

           //If `true` the size of a database can be larger than 2GB. Default: false
          'large': false,

          //If `true` collection's records will be compressed
          // with DEFLATE compression. Default: false
          'compressed': false
        }

    :param string cname: Collection name
    :param map [copts]: Options to be used when creating the collection
    :param function [cb]: Callback called with an error argument


.. js:function:: db.dropCollection(cname, [prune=false], [cb])

    Drop the collection specified by `cname`. If `prune` set to `true` the collection data
    will be removed from disk.

    :param string cname: Collection name
    :param boolean [prune=false]: If `prune` set to `true` the collection data will be removed from disk
    :param function [cb]: Callback called with an error argument


.. js:function:: db.save(cname, jsarr, [opts={}], [cb])

    Save/update specified in `jsarr` JSON objects in the collection are identified by `cname`.
    If a collection with `cname` does not exists it will be created.

    Every persistent object may have a unique :term:`ObjectId` placed in the `_id` property.
    If a saved object does not have `_id` it will be autogenerated.
    To identify and update object it should contains the `_id` property.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    A save options `opts`:

    .. code-block:: js

        {
            //A saved object will be merged with who's
            // already persisted in db.
            merge: false
        }

    **Calling variations:**

    .. code-block:: js

        save(cname, <json object>|<Array of json objects>)
        save(cname, <json object>|<Array of json objects>, options)
        save(cname, <json object>|<Array of json objects>, cb)
        save(cname, <json object>|<Array of json objects>, options, cb)

    .. note::

        Field names of passed JSON objects may not contain `$` and `.` characters,
        error condition will be fired in this case.

    :param string cname: Collection name.
    :param array|object jsarr: Signle JSON object or array of JSON objects to save.
    :param object [opts]: Save options.
    :param function [cb]: Callback function with arguments: `(error, {Array} of OIDs of saved objects)`
    :return: An `OID` array of saved object in `synchronous` mode otherwise return `undefined`.

.. js:function:: db.load(cname, oid, [cb])

    Retrieve JSON object identified by OID.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    Return JSON object or `null` if it is not found.

    :param string cname: Collection name
    :param string oid: Object identifier (OID)
    :param function [cb]: Callback function
    :return: JSON `Object` or `null` if it is not found in `synchronous` mode otherwise return `undefined`.


.. js:function:: db.remove(cname, oid, [cb])

    Remove document object identified by :term:`ObjectId` from the collection `cname`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string [oid]: :term:`ObjectId`
    :return: `undefined`


.. js:function:: db.find(cname, ...)

    Retrieve a set of documents matched to the specified query.
    :ref:`See the complete query language specification <ql>`

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    A callback function `cb` will be called with
    the following arguments: `error, cursor, count` where:

    * error: Error object
    * cursor: Cursor object to traverse documents found
    * count: Total number of matched documents.

    **Calling variations:**

    .. code-block:: js

        find(cname, [cb])
        find(cname, qobj, [cb])
        find(cname, qobj, hints, [cb])
        find(cname, qobj, qobjarr, [cb])
        find(cname, qobj, qobjarr, hints, [cb])

    :param string cname: Collection name
    :param object [qobj]: Main JSON query object
    :param object [hints]: JSON object specifies the query :ref:`hints <qhints>`
    :param array [qobjarr]: Array of extra `OR` joined query objects
    :param function [cb]: Callback accepting arguments: `error, cursor, count`
    :return: `undefined` if `cb` is provided.
              If `cb` is not provided and `$onlycount` query hint is set returns count `number`.
              If `cb` is not provided and no `$onlycount` query hint returns `cursor` object.


.. js:function:: db.findOne(cname, ...)

    Retrieve a first found document matched to the specified query.
    :ref:`See the complete query language specification <ql>`

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    A callback function `cb` will be called with
    the following arguments: `error, object` where:

    * error: Error object
    * document: Found document or `null` if no matched documents.

    **Calling variations:**

    .. code-block:: js

        findOne(cname, [cb])
        findOne(cname, qobj, [cb])
        findOne(cname, qobj, hints, [cb])
        findOne(cname, qobj, qobjarr, [cb])
        findOne(cname, qobj, qobjarr, hints, [cb])

    :param string cname: Collection name
    :param object [qobj]: Main JSON query object
    :param object [hints]: JSON object specifies the query :ref:`hints <qhints>`
    :param array [qobjarr]: Array of extra `OR` joined query objects
    :param function [cb]: Callback accepting arguments: `error, document`
    :return: `undefined` if `cb` is provided,
              otherwise return a found `document` or `null`
              if no documents found.

.. js:function:: db.command(cmd, [cb])

    Execute ejdb database command.
    :ref:`See the database commands documentation <cmd>`

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    A callback function `cb` will be called with
    the following arguments: `error, object` where:

    * error: Error object
    * response: JSON object: :ref:`command execution response <cmd_response>`.

    :param json cmd: Command specification
    :param function [cb]: Callback function arguments: `error, response`


.. js:function:: db.update(cname, ...)

    Convenient method to execute update queries.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    A callback function `cb` will be called with
    the following arguments: `error, count` where:

    * error: Error object
    * count: Number of documents updated.

    **Calling variations:**

    .. code-block:: js

        update(cname, qobj, [cb])
        update(cname, qobj, hints, [cb])
        update(cname, qobj, qobjarr, [cb])
        update(cname, qobj, qobjarr, hints, [cb])


    :param string cname: Collection name
    :param object [qobj]: Main JSON query object
    :param object [hints]: JSON object specifies the query :ref:`hints <qhints>`
    :param array [qobjarr]: Array of extra `OR` joined query objects
    :param function [cb]: Callback function accepting arguments: `error, count`
    :return: Number of updated documents if `cb` is not provided otherwise `undefined`


.. js:function:: db.count(cname, ...)

    Convenient method to execute `count(*)` queries.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    A callback function `cb` will be called with
    the following arguments: `error, count` where:

    * error: Error object
    * count: Number of documents matched the query.

    **Calling variations:**

    .. code-block:: js

        count(cname, qobj, [cb])
        count(cname, qobj, hints, [cb])
        count(cname, qobj, qobjarr, [cb])
        count(cname, qobj, qobjarr, hints, [cb])

    :param string cname: Collection name
    :param object [qobj]: Main JSON query object
    :param object [hints]: JSON object specifies the query :ref:`hints <qhints>`
    :param array [qobjarr]: Array of extra `OR` joined query objects
    :param function [cb]: Callback function accepting arguments: `error, count`
    :return: Number of documents matched the query if `cb` is not provided otherwise `undefined`


.. js:function:: db.sync([cb])

    Synchronize entire database and all of its collections with disk.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param function [cb]: Callback function accepting `error`


.. js:function:: db.dropIndexes(cname, fieldpath, [cb])

    DROP indexes of all types for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.dropIndexes(cname, fieldpath, [cb])

    OPTIMIZE indexes of all types for JSON `fieldpath`.
    Performs B+ tree index file optimization.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.ensureStringIndex(cname, fieldpath, [cb])

    Ensure index presence of `string` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
        :param string fieldpath: Documents fieldpath
        :param function [cb]: Callback function accepting `error`


.. js:function:: db.rebuildStringIndex(cname, fieldpath, [cb])

    Rebuild index of `string` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.dropStringIndex(cname, fieldpath, [cb])

    Drop index of `string` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.ensureIStringIndex(cname, fieldpath, [cb])

    Ensure case insensitive index presence of `string` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.rebuildIStringIndex(cname, fieldpath, [cb])

    Rebuild case insensitive index of `string` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.dropIStringIndex(cname, fieldpath, [cb])

    Drop case insensitive index of `string` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`

.. js:function:: db.ensureNumberIndex(cname, fieldpath, [cb])

    Ensure index presence of `number` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.rebuildNumberIndex(cname, fieldpath, [cb])

    Rebuild index of `number` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.dropNumberIndex(cname, fieldpath, [cb])

    Drop index of `number` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`

.. js:function:: db.ensureArrayIndex(cname, fieldpath, [cb])

    Ensure index presence of `array` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.rebuildArrayIndex(cname, fieldpath, [cb])

    Rebuild index of `array` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.

    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`


.. js:function:: db.dropArrayIndex(cname, fieldpath, [cb])

    Drop index of `array` type for JSON `fieldpath`.

    Execution of this function will be `asynchronous` if `cb` is
    provided, otherwise it will be executed in `synchronous` mode.


    :param string cname: Collection name
    :param string fieldpath: Documents fieldpath
    :param function [cb]: Callback function accepting `error`

.. js:function:: db.getDBMeta()

    Get description of EJDB database and its collections.

.. js:function:: db.beginTransaction(cname, [cb])

    Begin collection transaction.

.. js:function:: db.commitTransaction(cname, [cb])

    Commit collection transaction.

.. js:function:: db.rollbackTransaction(cname, [cb])

    Rollback collection transaction.

.. js:function:: db.getTransactionStatus(cname, [cb])

   Get collection transaction status.




